
var graphs=[];var last=[];last['time']=-1;var tp_data=[];var tp_datap=[];var tp_hidden=[];var first_call=true;var TOTAL_POINTS=50;var timeout_id='';var ethernet_pre_name='eth';var wireless_pre_name='radio';function update_graph(str_id){var graph=graphs['tp_graph_'+str_id];if(!graph){return;}
var series=tp_data[str_id];var data=[];if(series==null){return;}
for(var k=0;k<series.length;k++){var set=series[k];if(tp_hidden[str_id+set.label]==null||!tp_hidden[str_id+set.label]){data.push(set);}else{data.push({label:set.label,data:[]});}}
graph.setData(data);graph.setupGrid();graph.draw();$('#tp_graph_'+str_id+' .legendColorBox').css('cursor','pointer').click(function(){var label=$(this).parent().children('.legendLabel').text();if(tp_hidden[str_id+label]==null){tp_hidden[str_id+label]=true;}else{tp_hidden[str_id+label]=!tp_hidden[str_id+label];}
update_graph(str_id);});$('#tp_graph_'+str_id+' .legendLabel').each(function(){var text=$(this).text();$(this).css('font-style',tp_hidden[str_id+text]?'italic':'normal');});$('#tp_graph_'+str_id+' .legendColorBox').hover(function(){$(this).css('background-color','rgb(243, 243, 243)');},function(){$(this).css('background-color','inherit');});}
function update_graphs(){for(var i=0;i<num_radios;i++){update_graph(wireless_pre_name+i);}
for(var i=0;i<num_eth_ports;i++){var interface_index=i;update_graph(ethernet_pre_name+interface_index);}
if(supports_3g&&linked_3g){update_graph(dev_name_3g);}}
function send_client_status_request(ifname){$.getJSON(client_status_api_url,{ifname:ifname},function(data){var rate_str='-';var bar_color_id='#bar_color'+ifname;if(data.state=='up'&&data.rssi_str!=null){$('#rssi_str'+ifname).html(data.rssi_str);$(bar_color_id)[0].className='';$(bar_color_id).addClass('bar '+data.rssi_class);$(bar_color_id).css('width',data.rssi_percentage+'%');if(data.remote_mac!=null){$('#remote_mac'+ifname).html(data.remote_mac.toUpperCase());}
$('#not_connected'+ifname).hide();$('#connected'+ifname).show();$('#connected_detail'+ifname).show();if(data.tx_rate!=null&&data.tx_rate!=''&&data.tx_rate!='-'){rate_str='Tx: '+data.tx_rate+' Mbps, Rx: '+data.rx_rate+' Mbps';}
$('#rate'+ifname).text(rate_str);$('#signal_bar'+ifname).attr('data-percent',data.rssi+' dBm');}else{$('#remote_rssi_str'+ifname).html('<i class=\'icon-warning-sign\'></i> Remote link is down');$('#not_connected'+ifname).show();$('#connected'+ifname).hide();$('#connected_detail'+ifname).hide();$('#remote_mac'+ifname).html('-');$('#rate'+ifname).text('-');}});}
function send_client_list_request(ifname,radid,vapid,force,one_time){if(!one_time){setTimeout(function(){send_client_list_request(ifname,radid,vapid,false,false);},60*3*1000);}
$('.refresh-client-btn[data-ifname="'+ifname+'"]').hide();$.getJSON(client_api_url,{ifname:ifname},function(data){$('.refresh-client-btn[data-ifname="'+ifname+'"]').show();var client_count=0,total_count=0,$table=$('#client_table_'+ifname);$table.data('footable').reset();$table.find('tr:gt(0)').remove();$.each(data.clients,function(i,client){client_count++;var signal_values='';var signal_avg=0;if(client.signal!=undefined&&client.signal.length>0){signal_values=' (';$.each(client.signal,function(i,v){if(i>0){signal_values+=', ';}
signal_values+=v;signal_avg+=+v;});signal_values+=')';signal_avg=Math.round(signal_avg/client.signal.length);}
$('#remote_mac'+ifname).html(client.mac.toUpperCase());$table.find('tbody').append($('<tr>').append($('<td><span></span></td>')).append($('<td>').text(client.name?client.name:'n/a')).append($('<td>').text(client.mac.toUpperCase())).append($('<td>').text(client.ip?client.ip:'n/a')).append($('<td>').text(signal_avg+signal_values+' dBm')).append($('<td>').text(format_Second(client.duration))).append($('<td>').text(format_Second(client.idleTime))).append($('<td>').text(client.tx_rate+' Mbps')).append($('<td>').text(client.rx_rate+' Mbps')).append($('<td>').text(format_bytesToSize(client.tx_bytes))).append($('<td>').text(format_bytesToSize(client.rx_bytes))).append($('<td>').text(client.tx_packets)).append($('<td>').text(client.rx_packets)));});$table.footable();$('.client_expandable').attr('style','');if(client_count==0){$('#no_clients_msg_'+ifname).show();$('#not_connected'+ifname).show();$('#connected'+ifname).hide();$('#connected_detail'+ifname).hide();$('#remote_mac'+ifname).html('-');}else{$('#no_clients_msg_'+ifname).hide();$('#not_connected'+ifname).hide();$('#connected'+ifname).show();$('#connected_detail'+ifname).show();}
$('#vap_client_count_'+radid+'_'+vapid).text(client_count);$('.vap_client_count_'+radid).each(function(c,span){total_count+=parseInt($(span).text());});$('#radio_client_count_'+radid).text(total_count);}).fail(function(){$('.refresh-client-btn[data-ifname="'+ifname+'"]').show();});}
var last_rate=new Array();function send_stats_request(force){$.getJSON(stats_api_url,{},function(data){var time=data.time,time_diff=0;if(last['time']>0){time_diff=time-last['time'];}
if(time_diff>0){if(supports_3g&&linked_3g){tp_data[dev_name_3g]=[];}
for(var i=0;i<num_radios;i++){tp_data[wireless_pre_name+i]=[];}
for(var i=0;i<num_eth_ports;i++){tp_data[ethernet_pre_name+i]=[];}}
$.each(data.ifaces,function(iface,val){var options=['tx','rx'];options.forEach(function(option){var res=[];var key=iface+'_'+option;var bytes=option=='tx'?val.tx_bytes:val.rx_bytes;var _rate=option=='tx'?val.tx_rate:val.rx_rate;if(tp_datap[key]==undefined){tp_datap[key]=[];for(var t=0;t<TOTAL_POINTS;t++){tp_datap[key][t]=-1;}}
if(last[key]!=null&&time_diff>0){var rate=0;rate=_rate/1024;if(tp_datap[key].length>0){tp_datap[key]=tp_datap[key].slice(1);}
tp_datap[key].push(rate);for(var j=0;j<tp_datap[key].length;++j){res.push([j,tp_datap[key][j]]);}}
if(time_diff>0){var label=option;tp_data[iface].push({data:res,label:label,});}
last[key]=bytes;last['time']=time;});});update_graphs();});if(!$('#tab_traffic').hasClass('active')&&(force!=true)){console.log('Traffic tab not active, stop getting stats');return;}
if(first_call){first_call=false;clearTimeout(timeout_id);timeout_id=setTimeout(send_stats_request,1*1000);}else{clearTimeout(timeout_id);timeout_id=setTimeout(send_stats_request,3*1000);}}
function format_Second(v){if(v=='-'){return v;}
var day=Math.floor(v/(24*3600));var hr=Math.floor((v-(day*24*3600))/3600);var min=Math.floor((v-(day*24*3600)-(hr*3600))/60);var sec=parseInt(v-(day*24*3600)-(hr*3600)-(min*60));var str='';if(day&&day!=0){str+=day+' day ';}
if(hr&&hr!=0){str+=hr+' hr ';}
str+=min+' min '+sec+' sec';return(str);}
function format_bytesToSize(bytes){if(bytes===0){return'0 B';}
if(bytes=='N/A'){return bytes;}
var k=1000,sizes=['B','KB','MB','GB','TB','PB','EB','ZB','YB'],i=Math.floor(Math.log(bytes)/Math.log(k));return(bytes/Math.pow(k,i)).toPrecision(3)+' '+sizes[i];}
function format_tr_data_rate(v){var data_rate_arr=new Array(27.5,385,770,962.5,1155,1251.25,1540,1925,2310,2502.5);return data_rate_arr[v];}
function format_data_rate(v,axis){if(v<1000){return v.toFixed(0)+' Kb/s';}
if(v>=1000&&v<1000000){if(axis!=undefined){for(var i=0;i<axis.ticks.length;i++){if(axis.ticks[i].v<1000){axis.ticks[i].label=axis.ticks[i].v/1000+' Mb/s';}}}
return(v/1000).toFixed(1)+' Mb/s';}
if(v>=1000000){if(axis!=undefined){for(var i=0;i<axis.ticks.length;i++){if(axis.ticks[i].v<1000000){axis.ticks[i].label=axis.ticks[i].v/1000/1000+' Gb/s';}}}
return(v/1000/1000).toFixed(1)+' Gb/s';}}
function setup_graph(str_id){var name='tp_graph_'+str_id;if($('#'+name).hasClass('link-down')){return;}
graphs[name]=$.plot('#'+name,[],{series:{shadowSize:0},points:{show:true,radius:1},lines:{show:true},grid:{hoverable:true,clickable:true,borderColor:'#A3A3A3',borderWidth:1,},yaxis:{min:0,tickFormatter:format_data_rate,minTickSize:1,labelWidth:40},xaxis:{show:false},legend:{show:true,noColumns:1,}});$('#'+name).css({'width':'100%'});$('#'+name).bind('plothover',function(event,pos,item){$('#graph_tooltip').remove();if(item){var tooltip=format_data_rate(item.series.data[item.dataIndex][1]);$('<div id="graph_tooltip">'+tooltip+'</div>').css({position:'absolute',display:'none',top:item.pageY+5,left:item.pageX+5,border:'1px solid #fdd',padding:'2px','background-color':'gray',color:'white',zIndex:100,opacity:0.80}).appendTo('body').fadeIn(200);}});}
function setup_graphs(){for(i=0;i<num_eth_ports;i++){setup_graph(ethernet_pre_name+i);}
for(i=0;i<num_radios;i++){setup_graph(wireless_pre_name+i);}
if(supports_3g&&linked_3g){setup_graph(dev_name_3g);}}
function renew_dhcp(){$.get(rewnew_url,function(data){location.reload();});}
var wifi_stats_loaded=false;$(function(){$('.network-table').footable();$('.client-table').footable();$('.error-msg-visible').each(function(){$('#svc_alert_bell').css('display','inline-block');$('#services_tab_btn').css('color','#AC1028');return false;});fill_routed_ports();setup_graphs();check_firmware();$('#network_tab_btn,#wifi_tab_btn,.radio-tab-btns,#services_tab_btn').click(function(e){e.preventDefault();$(this).tab('show');$('.footable').trigger('footable_resize');});$('#grneral_tab_btn,#network_tab_btn,#wifi_tab_btn,#traffic_tab_btn,#services_tab_btn').click(function(e){var current_protocal=location.protocol;var current_hostname=location.hostname;var current_port=location.port;var current_pathname=location.pathname;if(current_port!=''){current_port=':'+current_port;}
location.href=current_protocal+'//'+current_hostname+current_port+current_pathname+'#'+this.id;});$('#traffic_tab_btn').click(function(){clearTimeout(timeout_id);send_stats_request(true);});$('#wifi_tab_btn').click(function(){if(wifi_stats_loaded){return;}
wifi_stats_loaded=true;$('.refresh-client-btn').each(function(){var $btn=$(this);setTimeout(function(){var ifname=$btn.data('ifname');var radid=$btn.data('radid');var vapid=$btn.data('vapid');send_client_list_request(ifname,radid,vapid,true,false);},Math.random()*2000);});});$('.refresh-client-status-btn').each(function(){var ifname=$(this).data('ifname');setInterval(function(){send_client_status_request(ifname);},10*1000);send_client_status_request(ifname);});$('.link-down').each(function(key,value){$(value).html('<div style="margin-top:9px;margin-bottom:5px"><div class="link-down-inner">'
+'<div class="link-down-contents"><center>'
+'<i class="icon-ban-circle" style="padding-right:5px"></i>'
+$(value).attr('iface_name')
+' </center>'
+'</div></div></div>');});$('.link-down').css({'width':'100%','height':'auto'});$('.refresh-client-btn').click(function(){send_client_list_request($(this).data('ifname'),$(this).data('radid'),$(this).data('vapid'),true,true);return false;});$('.refresh-client-status-btn').click(function(){send_client_status_request($(this).data('ifname'));return false;});var location_href_hash=location.hash;$(location_href_hash).click();});function fill_routed_ports(){var port_list=$('<div/>');var has_ports=false;$('#tab_lans .bridge_member').each(function(){has_ports=true;port_list.append($(this).clone());port_list.append('&nbsp;&nbsp;');});if(has_ports){$('#routed_ports').html(port_list.html());}}
function check_firmware(){var current_major_ver=0,current_minor_ver=0,current_patch_ver=0;var re=/^(\d+)\.(\d+)\.(\d+)*/;if(re.test(fw_ver)){current_major_ver=RegExp.$1;current_minor_ver=RegExp.$2;current_patch_ver=RegExp.$3;}
$.getJSON(newfw_version_api_url,function(data){if(data!=''){var major_ver=data.major_version;var minor_ver=data.minor_version;var patch_ver=data.patch;var url=data.url;var flag_show_fw=false;var upgrade_msg='Warning! You are running out-of-date firmware! If you\'d like to upgrade please download a new firmware image <a href=\''+url+'\' target=\'_blank\'>here</a>.';if(major_ver>current_major_ver){flag_show_fw=true;}else if(major_ver==current_major_ver){if(minor_ver>current_minor_ver){flag_show_fw=true;}else if(minor_ver==current_minor_ver){if(patch_ver>current_patch_ver){flag_show_fw=true;}}}
if(flag_show_fw){cbi_show_form_error('upgrade_msg_placeholder',upgrade_msg);}else{}}}).fail(function(jqxhr,textStatus,error){});}