'use strict';'require view';'require poll';'require ui';'require uci';'require rpc';'require form';var callInitList,callInitAction,callTimezone,callGetLocaltime,CBILocalTime;callInitList=rpc.declare({object:'luci',method:'getInitList',params:['name'],expect:{'':{}},filter:function(res){for(var k in res)
return+res[k].enabled;return null;}});callInitAction=rpc.declare({object:'luci',method:'setInitAction',params:['name','action'],expect:{result:false}});callGetLocaltime=rpc.declare({object:'luci',method:'getLocaltime',expect:{result:0}});callTimezone=rpc.declare({object:'luci',method:'getTimezones',expect:{'':{}}});CBILocalTime=form.DummyValue.extend({renderWidget:function(section_id,option_id,cfgvalue){return E([],[E('div',{'id':'localtime','type':'text','style':'margin-top:5px','readonly':true,})]);},});return view.extend({load:function(){return Promise.all([callInitList('sysntpd'),callTimezone(),callGetLocaltime(),uci.load('luci'),uci.load('system'),uci.load('firewall')]);},render_ssh:function(){var m,s,o;m=new form.Map('dropbear',_('Services'));m.chain('firewall');s=m.section(form.NamedSection,'@dropbear[0]','dropbear',_('SSH'));s.anonymous=true;s.addremove=false;o=s.option(form.Flag,'enable',_('SSH Server'));o.rmempty=false;o.default=o.enabled;o=s.option(form.Value,'Port',_('Port'));o.depends('enable','1');o.rmempty=false;o.default='22';o.datatype="port"
var rule_list=s.map.data.state.values.firewall;$.each(rule_list,function(index,rule){if(rule.name=="Allow-SSH"){var sid=rule[".name"];o=s.option(form.Flag,'enabled',_('Allow SSH from WAN'));o.depends('enable','1');o.rmempty=false;o.default=o.disabled;o.cfgvalue=function(){var ssh_enabled=uci.get('firewall',sid,'enabled');return ssh_enabled;};o.write=function(section_id,value){var dropbear_ssh_port=uci.get('dropbear','@dropbear[0]','Port');uci.set('firewall',sid,'dest_port',dropbear_ssh_port);uci.set('firewall',sid,'enabled',value);};}});return m.render();},render_ntp:function(ntpd_enabled,timezones,localtime){var m,s,o;m=new form.Map('system');m.chain('luci');s=m.section(form.NamedSection,'ntp','timeserver',_('Network Time (NTP)'));s.anonymous=true;s.addremove=false;o=s.option(CBILocalTime,'_systime',_('Local Time'));o.cfgvalue=function(){return localtime};o.ntpd_support=ntpd_enabled;o=s.option(form.Flag,'enable_server',_('NTP Service'));o.rmempty=false;o.default=o.disabled;o=s.option(form.DynamicList,'server',_('NTP Servers'));o.datatype='host(0)';o.depends('enable_server','1');o.remove=function(){};o=s.option(form.ListValue,'zonename',_('Timezone'));o.value('UTC');var zones=Object.keys(timezones||{}).sort();for(var i=0;i<zones.length;i++)
o.value(zones[i]);o.write=function(section_id,formvalue){var tz=timezones[formvalue]?timezones[formvalue].tzstring:null;uci.set('system',section_id,'zonename',formvalue);uci.set('system',section_id,'timezone',tz);};return m.render().then(function(mapEl){poll.add(function(){return callGetLocaltime().then(function(t){var zone_name=uci.get('system','ntp','zonename');mapEl.querySelector('#localtime').textContent=new Date(t*1000).toLocaleString('en',{timeZone:zone_name,dateStyle:'medium',timeStyle:'long'});});});return mapEl;});},render:function(rpc_replies){var ntpd_enabled=rpc_replies[0],timezones=rpc_replies[1],localtime=rpc_replies[2];return Promise.all([this.render_ssh(),this.render_ntp(ntpd_enabled,timezones,localtime)]);}});