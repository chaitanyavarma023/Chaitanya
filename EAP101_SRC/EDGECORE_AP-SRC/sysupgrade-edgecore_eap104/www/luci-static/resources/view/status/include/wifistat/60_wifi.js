'use strict';'require baseclass';'require dom';'require network';'require fs';'require rpc';var callgetDynamicList=rpc.declare({object:'luci',method:'getDynamicList'});function renderbox(radio,networks,radio_dynamic_vlan_clients){var chan=null,freq=null,txpower=null,total_assoc=null,ch_bw=null,ieee_mode=null;var assoclist_length=0;for(var i=0;i<networks.length;i++){var net=networks[i];var this_ifname=net.getIfname();var is_dynamic_vlan=(net.ubus('net','config','dynamic_vlan')=="2");assoclist_length=net.assoclist.length;if(is_dynamic_vlan&&typeof(radio_dynamic_vlan_clients)=='object'){assoclist_length=0;net.assoclist=radio_dynamic_vlan_clients.results;for(var k=0;k<net.assoclist.length;k++){var bss=net.assoclist[k];if(bss.ifname!=undefined){var _arr_devs=bss.ifname.split('.');if(_arr_devs[0]==this_ifname){assoclist_length++;}}}}
total_assoc+=assoclist_length;chan=(chan!=null)?chan:net.getChannel();freq=(freq!=null)?freq:net.getFrequency();txpower=(txpower!=null)?txpower:net.getTXPower();}
var radio_status=radio._ubusdata.dev.config.disabled;var get_hwmode=radio._ubusdata.dev.config.hwmode;switch(get_hwmode){case"11ng":ieee_mode="802.11 g/n";break;case"11axg":ieee_mode="802.11 ax";break;case"11a":ieee_mode="802.11 a";break;case"11na":ieee_mode="802.11 a/n";break;case"11ac":ieee_mode="802.11 ac";break;case"11axa":ieee_mode="802.11 ax";break;default:ieee_mode="-";break;}
var get_htmode=radio._ubusdata.dev.config.htmode;ch_bw=get_htmode.split(/(\d+)/);if(radio.sid=="radio0"){var radio_freq='5 GHz';}else if(radio.sid=="radio1"){var radio_freq='2.4 GHz';}
var get_country=radio._ubusdata.dev.config.country;return[E('h4',_('Wireless Radio %s'.format(radio_freq))),' ',_('Radio Status'),E('em',radio_status?_('Disabled'):_('Enabled')),_('IEEE Mode'),radio_status?'-':ieee_mode,_('Op Mode'),radio_status?'-':net.getActiveMode(),_('Tx Power'),txpower?'%d %s (%s)'.format(txpower,_('dBm'),get_country):'-',_('Channel'),radio_status?'-':(chan?'%d (%.3f %s) @ %d %s'.format(chan,freq,_('GHz'),ch_bw[1],_('MHz')):'-'),_('Total Clients'),radio_status?'-':(total_assoc?'%d'.format(total_assoc):_('0'))];}
function mesh_renderbox(radio,networks){var mesh_table=[];for(var i=0;i<networks.length;i++){var net=networks[i],is_assoc=(net.getBSSID()!='00:00:00:00:00:00'&&net.getChannel()&&!net.isDisabled()),wmesh_id=net.sid;if(wmesh_id.includes("wmesh")){if(!net.isDisabled()){mesh_table.push(E('h5',_('Open Mesh')),' ',_('Mesh ID'),E('strong',net.getActiveSSID()||'-'),_('Security'),is_assoc?net.getActiveEncryption():'-',);}}}
return mesh_table;}
function ssid_renderbox(radio,networks,radio_dynamic_vlan_clients){var ssid_table=[];var assoclist_length=0;for(var i=0;i<networks.length;i++){var net=networks[i],is_assoc=(net.getBSSID()!='00:00:00:00:00:00'&&net.getChannel()&&!net.isDisabled()),wifi_iface=net.sid;assoclist_length=net.assoclist.length;var this_ifname=net.getIfname();var is_dynamic_vlan=(net.ubus('net','config','dynamic_vlan')=="2");if(is_dynamic_vlan&&typeof(radio_dynamic_vlan_clients)=='object'){assoclist_length=0;net.assoclist=radio_dynamic_vlan_clients.results;for(var k=0;k<net.assoclist.length;k++){var bss=net.assoclist[k];if(bss.ifname!=undefined){var _arr_devs=bss.ifname.split('.');if(_arr_devs[0]==this_ifname){assoclist_length++;}}}}
if(wifi_iface.includes("radio")){if(!net.isDisabled()){ssid_table.push(E('h5',_('SSID #%d'.format(i+1))),' ',_('Name'),E('strong',net.getActiveSSID()||'-'),_('Security'),is_assoc?net.getActiveEncryption():'-',_('BSSID'),is_assoc?(net.getActiveBSSID()||'-'):'-',_('Associated Clients'),is_assoc?(assoclist_length||'0'):'0');}}}
return ssid_table;}
function wifirate(rt){var s='%.1f\xa0%s'.format(rt.rate/1000,_('Mbps'));return s;}
function format_Second(v){if(v=='-'){return v;}
var day=Math.floor(v/(24*3600));var hr=Math.floor((v-(day*24*3600))/3600);var min=Math.floor((v-(day*24*3600)-(hr*3600))/60);var sec=parseInt(v-(day*24*3600)-(hr*3600)-(min*60));var str='';if(day&&day!=0){str+=day+' day ';}
if(hr&&hr!=0){str+=hr+' hr ';}
str+=min+' min '+sec+' sec';return(str);}
function format_bytesToSize(bytes){if(bytes===0){return'0 B';}
if(bytes=='N/A'){return bytes;}
var k=1000,sizes=['B','KB','MB','GB','TB','PB','EB','ZB','YB'],i=Math.floor(Math.log(bytes)/Math.log(k));return(bytes/Math.pow(k,i)).toPrecision(3)+' '+sizes[i];}
return baseclass.extend({title:_('Wireless'),handleDelClient:function(wifinet,mac,ev){dom.parent(ev.currentTarget,'.tr').style.opacity=0.5;ev.currentTarget.classList.add('spinning');ev.currentTarget.disabled=true;ev.currentTarget.blur();wifinet.disconnectClient(mac,true,5,60000);},load:function(){return Promise.all([network.getWifiDevices(),network.getWifiNetworks(),network.getHostHints(),L.resolveDefault(callgetDynamicList(),{}),network.getECDhcpList()]).then(function(radios_networks_hints){var tasks=[];for(var i=0;i<radios_networks_hints[1].length;i++)
tasks.push(L.resolveDefault(radios_networks_hints[1][i].getAssocList(),[]).then(L.bind(function(net,list){net.assoclist=list.sort(function(a,b){return a.mac>b.mac});},this,radios_networks_hints[1][i])));return Promise.all(tasks).then(function(){return radios_networks_hints;});});},render:function(data){var seen={},radios=data[0],networks=data[1],hosthints=data[2],radio_dynamic_vlan_clients=data[3],EChosthints=data[4];var table=E('div',{'class':'table'});for(var i=0;i<radios.sort(function(a,b){a.getName()>b.getName()}).length;i++){var radio_fields=renderbox(radios[i],networks.filter(function(net){return net.getWifiDeviceName()==radios[i].getName()}),radio_dynamic_vlan_clients);print_renderbox(radio_fields);var mesh_fields=mesh_renderbox(radios[i],networks.filter(function(net){return net.getWifiDeviceName()==radios[i].getName()}));print_renderbox(mesh_fields);var ssid_fields=ssid_renderbox(radios[i],networks.filter(function(net){return net.getWifiDeviceName()==radios[i].getName()}),radio_dynamic_vlan_clients);print_renderbox(ssid_fields);}
function print_renderbox(fields){for(var i=0;i<fields.length;i+=2){table.appendChild(E('div',{'class':'tr'},[E('div',{'class':'td left','width':'33%'},[fields[i]]),E('div',{'class':'td left'},[(fields[i+1]!=null)?fields[i+1]:' '])]));}}
if(!table.lastElementChild)
return null;var assoclist=E('div',{'class':'table assoclist'},[E('div',{'class':'tr table-titles'},[E('div',{'class':'th nowrap'},_('Network')),E('div',{'class':'th'},_('Wireless Radio')),E('div',{'class':'th'},_('Name')),E('div',{'class':'th hide-xs'},_('MAC-Address')),E('div',{'class':'th'},_('IP Address')),E('div',{'class':'th'},'%s'.format(_('Signal'))),E('div',{'class':'th'},_('Connected Time')),E('div',{'class':'th'},_('Idle Time')),E('div',{'class':'th'},'%s'.format(_('Client TX Rate'))),E('div',{'class':'th'},'%s'.format(_('Client RX Rate'))),E('div',{'class':'th'},_('TX')),E('div',{'class':'th'},_('RX')),E('div',{'class':'th'},_('TX Packets')),E('div',{'class':'th'},_('RX Packets'))])]);var rows=[];for(var i=0;i<networks.length;i++){var this_ifname=networks[i].getIfname();var is_dynamic_vlan=(networks[i].ubus('net','config','dynamic_vlan')=="2");if(is_dynamic_vlan&&typeof(radio_dynamic_vlan_clients)=='object'){networks[i].assoclist=radio_dynamic_vlan_clients.results;}
for(var k=0;k<networks[i].assoclist.length;k++){var bss=networks[i].assoclist[k],name=EChosthints.getHostnameByMACAddr(bss.mac),ipv4=EChosthints.getIPAddrByMACAddr(bss.mac);if(is_dynamic_vlan){if(bss.ifname!=undefined){var _arr_devs=bss.ifname.split('.');if(_arr_devs[0]!=this_ifname){continue;}}}
var txrx_bytes=new Uint32Array(2);txrx_bytes[0]=bss.tx.bytes;txrx_bytes[1]=bss.rx.bytes;if(networks[i].getFrequency()>=5)
var radio_freq='5 GHz';else
var radio_freq='2.4 GHz';var row=[networks[i].getActiveSSID(),radio_freq,name||'n/a',bss.mac,ipv4||'n/a','%d\xa0%s'.format(bss.signal,_('dBm')),format_Second(bss.connected_time),format_Second(bss.inactive/1000),wifirate(bss.tx),wifirate(bss.rx),format_bytesToSize(txrx_bytes[0]),format_bytesToSize(txrx_bytes[1]),'%d'.format(bss.tx.packets),'%d'.format(bss.rx.packets)];if(networks[i].isClientDisconnectSupported()){if(assoclist.firstElementChild.childNodes.length<6)
assoclist.firstElementChild.appendChild(E('div',{'class':'th cbi-section-actions'}));row.push(E('button',{'class':'cbi-button cbi-button-remove','click':L.bind(this.handleDelClient,this,networks[i],bss.mac)},[_('Disconnect')]));}
else{row.push('-');}
rows.push(row);}}
cbi_update_table(assoclist,rows,E('em',_('No information available')));return E([table,E('h3',_('Associated Stations')),assoclist]);}});