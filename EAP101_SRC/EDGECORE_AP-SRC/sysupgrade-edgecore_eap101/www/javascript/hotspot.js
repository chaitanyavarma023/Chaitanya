
var max_list_walled=32;var max_list_whitelist=16;var hs_ip_id='#cbid\\.hotspot\\.hotspot\\.listen';var dynip_mask_id='#cbid\\.hotspot\\.hotspot\\.dynip_mask';var start_id='#cbid\\.hotspot\\.hotspot\\.dhcpstart';var end_id='#cbid\\.hotspot\\.hotspot\\.dhcpend';function clear_validate_error(field){$(field).removeClass('tooltip-error');$(field).parents('.cbi-value').removeClass('error');$(field).attr('data-original-title','');}
function validateIp(ip_id){var ip_value=$(ip_id).val();if(!is_ip(ip_value)){set_err_msg($(ip_id),true,'Not a valid IPv4 address!');return false;}
return true;}
function validateIpAndNetmask(ip_id,netmask_id){var ip_value=$(ip_id).val();var netmask_value=$(netmask_id).val();if(!validateIp(ip_id)){return false;}
if(!cbi_validators.netmask(netmask_value)){set_err_msg($(netmask_id),true,'Not a valid netmask!');return false;}
if(is_broadcast(ip_value,netmask_value)){set_err_msg($(ip_id),true,'IP address is a broadcast IP.');return false;}
if(is_net(ip_value,netmask_value)){set_err_msg($(ip_id),true,'Not a valid network.');return false;}
return true;}
function validateDhcp(){var start_res=true;var end_res=true;var maxAmountAddress=0;var start_val=$(start_id).val();var end_val=$(end_id).val();clear_validate_error(start_id);clear_validate_error(end_id);if($(dynip_mask_id).val()!==''){maxAmountAddress=countAmountAddress($(dynip_mask_id).val());}
if((start_val.match(/^-?[0-9]+$/)==null)||(start_val<0)){set_err_msg($(start_id),true,'Not a valid positive number.');start_res=false;}else{start_val=parseInt(start_val,10);if(start_val<1||start_val>maxAmountAddress){set_err_msg($(start_id),true,'Allowed values are integers between 1 and '+maxAmountAddress+', inclusive.');start_res=false;}}
if((end_val.match(/^-?[0-9]+$/)==null)||(end_val<0)){set_err_msg($(end_id),true,'Not a valid positive number.');end_res=false;}else{end_val=parseInt(end_val,10);if(end_val<1||end_val>maxAmountAddress){set_err_msg($(end_id),true,'Allowed values are integers between 1 and '+maxAmountAddress+', inclusive.');end_res=false;}}
if(start_res&&end_res){if(start_val>end_val){set_err_msg($(start_id),true,'Value must be less than or equal to '+end_val+'.');start_res=false;}}
if(start_res&&end_res){if(end_val<start_val){set_err_msg($(end_id),true,'Value must be greater than or equal to '+start_val+'.');end_res=false;}}
return start_res&&end_res;}
function validateWall(){var res=true;var walled_id='#cbid\\.hotspot\\.hotspot\\.hs_wall';clear_validate_error(walled_id);if($(walled_id).val()!=''){$(walled_id).val(convert_list($(walled_id).val()));var tmp_arr=$(walled_id).val().split(' ');if(tmp_arr.length>max_list_walled){set_err_msg($(walled_id),true,'The total Walled Garden List is up to '+max_list_walled+'.');res=false;}else{var cidrToSubnets=['0.0.0.0','128.0.0.0','192.0.0.0','224.0.0.0','240.0.0.0','248.0.0.0','252.0.0.0','254.0.0.0','255.0.0.0','255.128.0.0','255.192.0.0','255.224.0.0','255.240.0.0','255.248.0.0','255.252.0.0','255.254.0.0','255.255.0.0','255.255.128.0','255.255.192.0','255.255.224.0','255.255.240.0','255.255.248.0','255.255.252.0','255.255.254.0','255.255.255.0','255.255.255.128','255.255.255.192','255.255.255.224','255.255.255.240','255.255.255.248','255.255.255.252','255.255.255.254','255.255.255.255'];for(var i=0;i<tmp_arr.length;i++){if(tmp_arr[i].search('/')!=-1){var ip_netmask=tmp_arr[i].split('/');if(ip_netmask.length>2){set_err_msg($(walled_id),true,'Some of walled garden addresses are invalid');return false;}
var _ip=ip_netmask[0];var _netmask=cidrToSubnets[ip_netmask[1]];if(!is_ip(_ip)){set_err_msg($(walled_id),true,'Not a valid IPv4 address!('+_ip+')');return false;}
if(_netmask==undefined||!cbi_validators.netmask(_netmask)){set_err_msg($(walled_id),true,'Not a valid netmask!('+ip_netmask[1]+')');return false;}
if(is_broadcast(_ip,_netmask)){set_err_msg($(walled_id),true,'IP address is a broadcast IP.('+_ip+')');return false;}}else{if(!cbi_validators.host(tmp_arr[i])){set_err_msg($(walled_id),true,'Some of walled garden addresses are invalid');return false;}}}}}
return res;}
function validateWhitelist(){var res=true;var whitelist_id='#cbid\\.hotspot\\.hotspot\\.hs_auth';clear_validate_error(whitelist_id);if($(whitelist_id).val()){$(whitelist_id).val(convert_list($(whitelist_id).val()));var tmp_arr=$(whitelist_id).val().split(' ');if(tmp_arr.length>max_list_whitelist){set_err_msg($(whitelist_id),true,'The total Auth White List is up to '+max_list_whitelist+'.');res=false;}else{for(var i=0;i<tmp_arr.length;i++){if(!is_mac(tmp_arr[i])){set_err_msg($(whitelist_id),true,'Not a valid MAC address!('+tmp_arr[i]+')');res=false;}}}}
return res;}
function validateIpAddrs(){var res_ip=true;var res_netmask=true;var hs_ip=$(hs_ip_id).val();var dynip_mask=$(dynip_mask_id).val();clear_validate_error(hs_ip_id);if(!validateIpAndNetmask(hs_ip_id,dynip_mask_id)){return false;}
for(var ipentry in ipdata){if(ipdata.hasOwnProperty(ipentry)){if(!ipentry.startsWith('hotspot')){var _ipentry=ipdata[ipentry];if(hs_ip===_ipentry.ip){set_err_msg($(hs_ip_id),true,'Your Internet IP address is the same as the '+_ipentry.friendly+' IP address!');return false;}
if(is_in_netmask(_ipentry.ip,_ipentry.nm,hs_ip)){set_err_msg($(hs_ip_id),true,'Your Internet IP address falls in the same subnet as the '+_ipentry.friendly+' network IP address.');return false;}}}}
return true;}
function validate_form(){var res_dhcp=validateDhcp();var res_wall=validateWall();var res_whitelist=validateWhitelist();var res_ip=validateIpAddrs();var res=(res_dhcp&&res_wall&&res_whitelist&&res_ip);if(!res){cbi_show_form_error();}
return res;}
function convert_list(val){var tmp_walled_str=val.replace(/\r\n|\r|\n/g,' ');tmp_walled_str=tmp_walled_str.replace(/(^\s*)|(\s*$)/g,'');tmp_walled_str=tmp_walled_str.replace(/\s+/g,' ');return tmp_walled_str;}
function get_mode(){var mode_id='cbid\\.hotspot\\.hotspot\\.hs_mode';var mode=$('#'+mode_id).val();if(mode===''||mode===undefined||mode===null){mode='external_portal';}
return mode;}
function change_mode(){var mode=get_mode();if(mode==='external_portal'||mode==='local_splash_ext_radius'){$('#cbi-hotspot-hotspot-dns1').show();$('#cbi-hotspot-hotspot-dns2').show();$('#cbi-hotspot-hotspot-dns_domain').show();}else{$('#cbid\\.hotspot\\.hotspot\\.dns1').val('');$('#cbid\\.hotspot\\.hotspot\\.dns2').val('');$('#cbid\\.hotspot\\.hotspot\\.dns_domain').val('');$('#cbi-hotspot-hotspot-dns1').hide();$('#cbi-hotspot-hotspot-dns2').hide();$('#cbi-hotspot-hotspot-dns_domain').hide();}
if(mode==='external_portal'||mode==='local_splash_ext_radius'){$('#cbi-hotspot1-hotspot').show();validate_radius();}else if(mode==='no_auth'||mode==='simple_pass'){$('#cbi-hotspot1-hotspot').hide();}
if(mode==='simple_pass'){cbi_validate_field('cbid.hotspot.hotspot.hs_simple_pass',func_field_optional_simple_pass,'hotspot_simple_pass(1,30)');}
if(mode==='external_portal'){var rad_id='#cbid\\.hotspot\\.hotspot\\.hs_radius_enabled';$(rad_id).change(validate_radius);}
if(mode==='external_portal'||mode==='no_auth'){cbi_validate_field('cbid.hotspot.hotspot.hs_portal_secret',func_field_optional_portal,'isBeginningWhiteSpace');cbi_validate_field('cbid.hotspot.hotspot.hs_portal_url',func_field_optional_portal,'isURL');}
handle_logo_visibility();if(mode!=='external_portal'&&mode!=='no_auth_ext_splash'){$('#cbid\\.hotspot\\.hotspot\\.hs_custom_portal').change(function(){$('#cbid\\.hotspot\\.hotspot\\.hs_portal_background').minicolors();handle_logo_visibility();});}
if(has_custom_logo){$('#remove_btn').removeClass('hidden');}else{$('#remove_btn').addClass('hidden');}}
function handle_logo_visibility(){var mode_id='cbid\\.hotspot\\.hotspot\\.hs_mode';var mode=$('#'+mode_id).val();switch(mode){case"external_portal":$('#cbi-hotspot-hotspot-hs_portal_url').show();$('#cbi-hotspot-hotspot-hs_portal_secret').show();$('#cbi-hotspot-hotspot-hs_custom_portal').hide();$('#cbi-hotspot-hotspot-_none').hide();$('#cbi-hotspot-hotspot-hs_swap_octets').show();$('#cbi-hotspot-hotspot-hs_simple_pass').hide();break;case"no_auth":$('#cbi-hotspot-hotspot-hs_portal_url').hide();$('#cbi-hotspot-hotspot-hs_portal_secret').hide();$('#cbi-hotspot-hotspot-hs_custom_portal').show();$('#cbi-hotspot-hotspot-hs_swap_octets').hide();$('#cbi-hotspot-hotspot-hs_simple_pass').hide();break;case"simple_pass":$('#cbi-hotspot-hotspot-hs_portal_url').hide();$('#cbi-hotspot-hotspot-hs_portal_secret').hide();$('#cbi-hotspot-hotspot-hs_custom_portal').show();$('#cbi-hotspot-hotspot-hs_swap_octets').hide();$('#cbi-hotspot-hotspot-hs_simple_pass').show();break;case"local_splash_ext_radius":$('#cbi-hotspot-hotspot-hs_portal_url').hide();$('#cbi-hotspot-hotspot-hs_portal_secret').hide();$('#cbi-hotspot-hotspot-hs_custom_portal').show();$('#cbi-hotspot-hotspot-hs_swap_octets').hide();$('#cbi-hotspot-hotspot-hs_simple_pass').hide();break;}
var custom_portal=$('#cbid\\.hotspot\\.hotspot\\.hs_custom_portal').is(':checked');if(custom_portal&&mode!=='external_portal'){$('#cbi-hotspot-hotspot-hs_portal_header').show();$('#cbi-hotspot-hotspot-hs_portal_background').show();$('#cbi-hotspot-hotspot-_display').show();$('#cbi-hotspot-hotspot-_none').show();}else{$('#cbi-hotspot-hotspot-hs_portal_header').hide();$('#cbi-hotspot-hotspot-hs_portal_background').hide();$('#cbi-hotspot-hotspot-_display').hide();$('#cbi-hotspot-hotspot-_none').hide();}}
var func_field_optional_simple_pass=function(){var mode_id='cbid\\.hotspot\\.hotspot\\.hs_mode';var mode=$('#'+mode_id).val();return(mode!=='simple_pass');};var func_field_optional_radius=function(){var mode_id='cbid\\.hotspot\\.hotspot\\.hs_mode';var rad_id='cbid\\.hotspot\\.hotspot\\.hs_radius_enabled';var mode=$('#'+mode_id).val();var rad_enable=true;if(mode==='external_portal'){rad_enable=$('#'+rad_id).is(':checked');}
return!((mode==='external_portal'&&rad_enable)||mode==='local_splash_ext_radius');};var func_field_optional_portal=function(){var mode_id='cbid\\.hotspot\\.hotspot\\.hs_mode';var mode=$('#'+mode_id).val();return!(mode==='external_portal'||mode==='no_auth_ext_splash');};function validate_radius(){var hotspotMode=get_mode();var radiusEnabled=$('#cbid\\.hotspot\\.hotspot\\.hs_radius_enabled').is(':checked');var radiusInputArr=new Array('hs_radius1','hs_radius2','hs_shared','hs_auth_port','hs_acct_port','loc_id','loc_name','nasid');var radiusOtherArr=new Array('hs_radsec_enable','hs_radius_eaptype');if(radiusDefaultRadius1===undefined){radiusDefaultRadius1=$('#cbid\\.hotspot\\.hotspot\\.hs_radius1').val();radiusDefaultRadius2=$('#cbid\\.hotspot\\.hotspot\\.hs_radius2').val();radiusDefaultShared=$('#cbid\\.hotspot\\.hotspot\\.hs_shared').val();radiusDefaultAuthPort=$('#cbid\\.hotspot\\.hotspot\\.hs_auth_port').val();radiusDefaultAcctPort=$('#cbid\\.hotspot\\.hotspot\\.hs_acct_port').val();radiusDefaultLocId=$('#cbid\\.hotspot\\.hotspot\\.loc_id').val();radiusDefaultLocName=$('#cbid\\.hotspot\\.hotspot\\.loc_name').val();radiusDefaultNasid=$('#cbid\\.hotspot\\.hotspot\\.nasid').val();radiusDefaultRadsecEnable=$('#cbid\\.hotspot\\.hotspot\\.hs_radsec_enable').val();radiusDefaultEapType=$('#cbid\\.hotspot\\.hotspot\\.hs_radius_eaptype').val();}
var i;if(radiusEnabled||hotspotMode==='local_splash_ext_radius'){for(i=0;i<=radiusInputArr.length;i++){$('#cbi-hotspot-hotspot-'+radiusInputArr[i]).show();}
for(i=0;i<=radiusOtherArr.length;i++){$('#cbi-hotspot-hotspot-'+radiusOtherArr[i]).show();}
cbi_validate_field('cbid.hotspot.hotspot.hs_radius1',func_field_optional_radius,'customHost');cbi_validate_field('cbid.hotspot.hotspot.hs_radius2',true,'customHost');cbi_validate_field('cbid.hotspot.hotspot.hs_shared',func_field_optional_radius,'isBeginningWhiteSpace');}else{for(i=0;i<=radiusInputArr.length;i++){clear_validate_error('#cbid\\.hotspot\\.hotspot\\.'+radiusInputArr[i]);$('#cbi-hotspot-hotspot-'+radiusInputArr[i]).hide();}
for(i=0;i<=radiusOtherArr.length;i++){$('#cbi-hotspot-hotspot-'+radiusOtherArr[i]).hide();}
$('#cbid\\.hotspot\\.hotspot\\.hs_radius1').val(radiusDefaultRadius1);$('#cbid\\.hotspot\\.hotspot\\.hs_radius2').val(radiusDefaultRadius2);$('#cbid\\.hotspot\\.hotspot\\.hs_shared').val(radiusDefaultShared);$('#cbid\\.hotspot\\.hotspot\\.hs_auth_port').val(radiusDefaultAuthPort);$('#cbid\\.hotspot\\.hotspot\\.hs_acct_port').val(radiusDefaultAcctPort);$('#cbid\\.hotspot\\.hotspot\\.loc_id').val(radiusDefaultLocId);$('#cbid\\.hotspot\\.hotspot\\.loc_name').val(radiusDefaultLocName);$('#cbid\\.hotspot\\.hotspot\\.nasid').val(radiusDefaultNasid);if(radiusDefaultRadsecEnable==='1'){$('#cbid\\.hotspot\\.hotspot\\.hs_radsec_enable').prop('checked',true);}
$('#cbid\\.hotspot\\.hotspot\\.hs_radius_eaptype').val(radiusDefaultEapType);}}
var radiusDefaultRadius1='';var radiusDefaultRadius2='';var radiusDefaultShared='';var radiusDefaultAuthPort='';var radiusDefaultAcctPort='';var radiusDefaultLocId='';var radiusDefaultLocName='';var radiusDefaultNasid='';var radiusDefaultRadsecEnable='';var radiusDefaultEapType='';$(function(){if(mgmt_enabled){$('#cbi\\.combobox\\.cbid\\.hotspot\\.hotspot\\.dynip_mask').attr('disabled','disabled');$('#cbi\\.combobox\\.cbid\\.hotspot\\.hotspot\\.dynip_mask').attr('style','background-color:#eee');$('#btn_save').attr('disabled','disabled');$('#btn_save').attr('style','background-color:#eee');}
radiusDefaultRadius1=$('#cbid\\.hotspot\\.hotspot\\.hs_radius1').val();radiusDefaultRadius2=$('#cbid\\.hotspot\\.hotspot\\.hs_radius2').val();radiusDefaultShared=$('#cbid\\.hotspot\\.hotspot\\.hs_shared').val();radiusDefaultAuthPort=$('#cbid\\.hotspot\\.hotspot\\.hs_auth_port').val();radiusDefaultAcctPort=$('#cbid\\.hotspot\\.hotspot\\.hs_acct_port').val();radiusDefaultLocId=$('#cbid\\.hotspot\\.hotspot\\.loc_id').val();radiusDefaultLocName=$('#cbid\\.hotspot\\.hotspot\\.loc_name').val();radiusDefaultNasid=$('#cbid\\.hotspot\\.hotspot\\.nasid').val();radiusDefaultRadsecEnable=$('#cbid\\.hotspot\\.hotspot\\.hs_radsec_enable').val();radiusDefaultEapType=$('#cbid\\.hotspot\\.hotspot\\.hs_radius_eaptype').val();$('#cbid\\.hotspot\\.hotspot\\.hs_portal_background').minicolors();$('#cbid\\.hotspot\\.hotspot\\.hs_mode').change(function(){var mode=get_mode();change_mode();});$(hs_ip_id).change(validateIpAddrs);$(start_id).change(validateDhcp);$(end_id).change(validateDhcp);$('#cbid\\.hotspot\\.hotspot\\.dynip_mask').change(function(){validateIpAddrs();validateDhcp();});$('#cbi\\.combobox\\.cbid\\.hotspot\\.hotspot\\.dynip_mask').change(function(){validateIpAddrs();validateDhcp();});var walled_id='#cbid\\.hotspot\\.hotspot\\.hs_wall';var whitelist_id='#cbid\\.hotspot\\.hotspot\\.hs_auth';$(walled_id).change(validateWall);$(whitelist_id).change(validateWhitelist);handle_logo_visibility();$('#cbi').submit(function(){if(!validate_form()){$('#form_error_msg').text('Some fields are invalid, please see messages below!');$('#form_error_msg_placeholder').removeClass('hide');return false;}else{if($('#cbid\\.hotspot\\.hotspot\\.hs_portal_background').val()==''){$('#cbid\\.hotspot\\.hotspot\\.hs_portal_background').val('#1d2024');}
return true;}});change_mode();cbi_validate_field('cbid.hotspot.hotspot.hs_simple_pass',func_field_optional_simple_pass,'hotspot_simple_pass(1,30)');cbi_validate_field('cbid.hotspot.hotspot.hs_portal_secret',func_field_optional_portal,'isBeginningWhiteSpace');cbi_validate_field('cbid.hotspot.hotspot.hs_portal_url',func_field_optional_portal,'isURL');cbi_validate_field('cbid.hotspot.hotspot.hs_redir_url',true,'isURL');cbi_validate_field('cbid.hotspot.hotspot.dhcpgateway',true,'ipaddr');cbi_validate_field('cbid.hotspot.hotspot.dhcpgatewayport',false,'port');});