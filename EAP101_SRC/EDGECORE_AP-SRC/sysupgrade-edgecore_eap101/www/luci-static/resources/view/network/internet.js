'use strict';'require view';'require dom';'require poll';'require rpc';'require uci';'require form';'require validation';function mask2cidr(mask){var cidr=''
for(m of mask.split('.')){if(parseInt(m)>255){throw'ERROR: Invalid Netmask'}
if(parseInt(m)>0&&parseInt(m)<128){throw'ERROR: Invalid Netmask'}
cidr+=(m>>>0).toString(2)}
if(cidr.substring(cidr.search('0'),32).search('1')!==-1){throw'ERROR: Invalid Netmask '+mask}
return cidr.split('1').length-1}
function getIpRangeFromAddressAndNetmask(str){var part=str.split("/");var ipaddress=part[0].split('.');var netmaskblocks=["0","0","0","0"];if(!/\d+\.\d+\.\d+\.\d+/.test(part[1])){netmaskblocks=("1".repeat(parseInt(part[1],10))+"0".repeat(32-parseInt(part[1],10))).match(/.{1,8}/g);netmaskblocks=netmaskblocks.map(function(el){return parseInt(el,2);});}else{netmaskblocks=part[1].split('.').map(function(el){return parseInt(el,10)});}
var baseAddress=ipaddress.map(function(block,idx){return block&netmaskblocks[idx];});return[baseAddress.join('.')];}
return view.extend({load:function(){return Promise.all([uci.load('network')]);},render:function(){var m,s,o;m=new form.Map('network',_('Internet Settings'),'');s=m.section(form.NamedSection,'wan','interface');s.addremove=false;s.anonymous=true;var inet_src=uci.get('network','wan','inet_src');var wan_type=s.option(form.ListValue,'proto',_('IP Address Mode'));wan_type.help_tip='Configure how you want your device to get its IP address.  DHCP is recommended for most cases.';wan_type.value('dhcp','DHCP');wan_type.value('static','Static IP');wan_type.value('pppoe','PPPoE');wan_type.value('none','None');var fallback_ipaddr=s.option(form.Value,'fallback_ip',_('Fallback IP'));fallback_ipaddr.help_tip='<b>Advanced Option</b><br/>Default IP when DHCP server fail or doesn\'t exist.';fallback_ipaddr.default='192.168.1.10';fallback_ipaddr.optional=false;fallback_ipaddr.force_required=true;fallback_ipaddr.depends('proto','dhcp');var fallback_mask=s.option(form.Value,'fallback_nm',_('Fallback Netmask'));fallback_mask.help_tip='<b>Advanced Option</b><br/>Default netmask when DHCP server fail or doesn\'t exist.';fallback_mask.value('255.255.255.0');fallback_mask.value('255.255.0.0');fallback_mask.value('255.0.0.0');fallback_mask.default='255.255.255.0';fallback_mask.optional=false;fallback_mask.force_required=true;fallback_mask.depends('proto','dhcp');var manual_hostname=s.option(form.Flag,'manual_hostname',_('Manual DHCP Client Id'));manual_hostname.help_tip='<b>Advanced Option</b><br/>Check this option to manually enter the client ID for the DHCP client. <br/><br/>If unchecked (recommended), the DHCP client id will be set to the system\'s hostname. ';manual_hostname.default='0';manual_hostname.switch_type='yes_no';manual_hostname.rmempty=false;manual_hostname.depends('proto','dhcp');var hostname=s.option(form.Value,'hostname',_('Hostname'));hostname.help_tip='This is the name assigned to your DHCP client, and will be associated with the IP address assigned by the DHCP server. ';hostname.depends('manual_hostname','1');var static_ipaddr=s.option(form.Value,'ipaddr',_('IP Address'));static_ipaddr.depends('proto','static');static_ipaddr.default='192.168.1.1';static_ipaddr.optional=false;static_ipaddr.force_required=true;var static_mask=s.option(form.Value,'netmask',_('Subnet Mask'));static_mask.depends('proto','static');static_mask.value('255.255.255.0');static_mask.value('255.255.0.0');static_mask.value('255.0.0.0');static_mask.default='255.255.255.0';static_mask.optional=false;static_mask.force_required=true;var def_gateway=s.option(form.Value,'gateway',_('Default Gateway'));def_gateway.depends('proto','static');def_gateway.default='192.168.1.254';def_gateway.optional=false;def_gateway.force_required=true;var dns=s.option(form.Value,'dns',_('DNS Servers'));dns.depends('proto','static');dns.datatype='custom_dns';dns.optional=false;dns.force_required=true;dns.cast='string';dns.default='8.8.8.8';dns.help_tip='<b>Info</b> If you want to input multiple DNS servers, please use spaces to separate the ip addresses.  The maximum number of servers allowed is 4.';var service_name=s.option(form.Value,'service',_('Service Name'));service_name.depends('proto','pppoe');var user=s.option(form.Value,'username',_('Username'));user.depends('proto','pppoe');user.datatype='is_ascii';var pass=s.option(form.Value,'password',_('Password'));pass.depends('proto','pppoe');pass.datatype='is_ascii';var mtu=s.option(form.Value,'mtu',_('MTU Size'));mtu.help_tip='<b>Advanced Option</b><br/><b>Warning!</b> Only change this value if you\'re an advanced user. ';var vlantag_network='wanvlan'
var vlantag=m.section(form.NamedSection,vlantag_network,'interface',_(''));vlantag.sub_title_class=true;vlantag.addremove=false;vlantag.anonymous=true;vlantag.div_heading_id='vlantag_title';vlantag.addl_classes='hide';var vlan_tag_enable=vlantag.option(form.Flag,'enabled',_('VLAN Tag'));vlan_tag_enable.rmempty=false;var vlan_tag_id=vlantag.option(form.Value,'ifname',_('VLAN Tag Id'));vlan_tag_id.depends('enabled','1');vlan_tag_id.force_required=true;vlan_tag_id.optional=false;vlan_tag_id.rmempty=true;vlan_tag_id.custom='style=\'width.50px\' ';vlan_tag_id.cfgvalue=function(section_id){var ifname=uci.get('network',section_id,'ifname');return ifname&&ifname.match(/\d+/)};vlan_tag_id.write=function(section_id,value){uci.set('network',section_id,'ifname',inet_src+'.'+value);};var vlan_tag_ipmode=vlantag.option(form.ListValue,'proto',_('IP Address Mode'));vlan_tag_ipmode.depends('enabled','1');vlan_tag_ipmode.value('dhcp','DHCP');vlan_tag_ipmode.value('static','Static IP');vlan_tag_ipmode.help_tip='<b>Advanced Option</b><br/>Configure how you want your device to get its IP address. DHCP is recommended for most cases.';var vlan_tag_ipaddr=vlantag.option(form.Value,'ipaddr',_('IP Address'));vlan_tag_ipaddr.depends('proto','static');vlan_tag_ipaddr.default='192.168.1.1';vlan_tag_ipaddr.optional=false;vlan_tag_ipaddr.cond_optional=true;var vlan_tag_netmask=vlantag.option(form.Value,'netmask',_('Subnet Mask'));vlan_tag_netmask.depends('proto','static');vlan_tag_netmask.value('255.255.255.0');vlan_tag_netmask.value('255.255.0.0');vlan_tag_netmask.value('255.0.0.0');vlan_tag_netmask.default='255.255.255.0';vlan_tag_netmask.optional=false;vlan_tag_netmask.cond_optional=true;var vlan_tag_gateway=vlantag.option(form.Value,'gateway',_('Default Gateway'));vlan_tag_gateway.depends('proto','static');vlan_tag_gateway.default='192.168.1.254';vlan_tag_gateway.optional=false;vlan_tag_gateway.cond_optional=true;var vlan_tag_fallback_ipaddr=vlantag.option(form.Value,'fallback_ip',_('Fallback IP'));vlan_tag_fallback_ipaddr.depends('proto','dhcp');vlan_tag_fallback_ipaddr.default='192.168.1.10';vlan_tag_fallback_ipaddr.optional=false;vlan_tag_fallback_ipaddr.cond_optiona=true;vlan_tag_fallback_ipaddr.help_tip='<b>Advanced Option</b><br/>Default IP when DHCP server fail or doesn\'t exist.';var vlan_tag_fallback_mask=vlantag.option(form.Value,'fallback_nm',_('Fallback Netmask'));vlan_tag_fallback_mask.depends('proto','dhcp');vlan_tag_fallback_mask.value('255.255.255.0');vlan_tag_fallback_mask.value('255.255.0.0');vlan_tag_fallback_mask.value('255.0.0.0');vlan_tag_fallback_mask.default='255.255.255.0';vlan_tag_fallback_mask.optional=false;vlan_tag_fallback_mask.cond_optional=true;vlan_tag_fallback_mask.help_tip='<b>Advanced Option</b><br/>Default netmask when DHCP server fail or doesn\'t exist.';var mgmt_network='managementvlan';var mgmt=m.section(form.NamedSection,mgmt_network,'interface',_(''));mgmt.sub_title_class=true;mgmt.addremove=false;mgmt.anonymous=true;mgmt.div_heading_id='mgmt_title';mgmt.addl_classes='hide';var mgmt_vlan=mgmt.option(form.Flag,'enabled',_('Mgmt VLAN'));mgmt_vlan.rmempty=false;mgmt_vlan.help_tip='<b>Advanced Option</b><br/>Select this option to enable a management VLAN on this device. Once you enable this option, you will no longer be able to access the device on any of the built-in local networks (like 192.168.2.1, for example). You will only be able to access the device from the VLAN\'ed network specified below. If this device\'s IP mode is set to DHCP, it will also request a new IP address in the subnet range assigned to the VLAN network.';var mgmt_vlan_tag=mgmt.option(form.Value,'ifname',_('Mgmt VLAN Id'));mgmt_vlan_tag.depends('enabled','1');mgmt_vlan_tag.cond_optional=true;mgmt_vlan_tag.default='100';mgmt_vlan_tag.optional=false;mgmt_vlan_tag.rmempty=true;mgmt_vlan_tag.custom='style=\'width.50px\' ';mgmt_vlan_tag.help_tip='<b>Advanced Option</b><br/>VLAN id for management VLAN.';mgmt_vlan_tag.cfgvalue=function(section_id){var ifname=uci.get('network',section_id,'ifname');return ifname&&ifname.match(/\d+/)};mgmt_vlan_tag.write=function(section_id,value){uci.set('network',section_id,'ifname','@wan.'+value);};var mgmt_vlan_ipmode=mgmt.option(form.ListValue,'proto',_('IP Address Mode'));mgmt_vlan_ipmode.depends('enabled','1');mgmt_vlan_ipmode.value('dhcp','DHCP');mgmt_vlan_ipmode.value('static','Static IP');mgmt_vlan_ipmode.help_tip='<b>Advanced Option</b><br/>Configure how you want your device to get its IP address.  DHCP is recommended for most cases.';mgmt_vlan_ipmode.write=function(section_id,value){uci.set('network',section_id,'proto',value);if(value=='dhcp'){uci.unset('network','managementvlanrule')
uci.unset('network','managementvlanroute')
uci.unset('network','managementvlannetwork')}else{var sid=uci.add('network','rule','managementvlanrule');if(sid!=null){uci.set('network',sid,'lookup','secdirect');uci.set('network',sid,'priority','10');uci.set('network',sid,'in','managementvlan');}
sid=uci.add('network','route','managementvlanroute');if(sid!=null){uci.set('network',sid,'interface','managementvlan');uci.set('network',sid,'target','0.0.0.0');uci.set('network',sid,'netmask','0.0.0.0');uci.set('network',sid,'table','secdirect');}
sid=uci.add('network','route','managementvlannetwork');if(sid!=null){uci.set('network',sid,'interface','managementvlan');uci.set('network',sid,'table','secdirect');var _netmask=this.map.lookupOption('netmask','managementvlan'),_ipaddr=this.map.lookupOption('ipaddr','managementvlan'),_netmask_val=_netmask?_netmask[0].formvalue('managementvlan'):null,_ipaddr_val=_ipaddr?_ipaddr[0].formvalue('managementvlan'):null;if(_netmask_val&&_ipaddr){var _target=getIpRangeFromAddressAndNetmask(_ipaddr_val+'/'+mask2cidr(_netmask_val))
uci.set('network',sid,'target',_target);uci.set('network',sid,'netmask',_netmask_val);}}}}
var mgmt_vlan_ipaddr=mgmt.option(form.Value,'ipaddr',_('IP Address'));mgmt_vlan_ipaddr.depends('proto','static');mgmt_vlan_ipaddr.default='192.168.1.1';mgmt_vlan_ipaddr.optional=false;mgmt_vlan_ipaddr.cond_optional=true;var mgmt_vlan_netmask=mgmt.option(form.Value,'netmask',_('Subnet Mask'));mgmt_vlan_netmask.depends('proto','static');mgmt_vlan_netmask.value('255.255.255.0');mgmt_vlan_netmask.value('255.255.0.0');mgmt_vlan_netmask.value('255.0.0.0');mgmt_vlan_netmask.default='255.255.255.0';mgmt_vlan_netmask.optional=false;mgmt_vlan_netmask.cond_optional=true;var mgmt_def_gateway=mgmt.option(form.Value,'gateway',_('Default Gateway'));mgmt_def_gateway.depends('proto','static');mgmt_def_gateway.default='192.168.1.254';mgmt_def_gateway.optional=false;mgmt_def_gateway.cond_optional=true;mgmt_def_gateway.cfgvalue=function(section_id){var _gateway=uci.get('network','managementvlanroute','gateway');return _gateway&&_gateway};mgmt_def_gateway.write=function(section_id,value){uci.set('network','managementvlanroute','gateway',value);};var mgmt_fallback_ipaddr=mgmt.option(form.Value,'fallback_ip',_('Fallback IP'));mgmt_fallback_ipaddr.depends('proto','dhcp');mgmt_fallback_ipaddr.default='192.168.1.10';mgmt_fallback_ipaddr.optional=false;mgmt_fallback_ipaddr.cond_optiona=true;mgmt_fallback_ipaddr.help_tip='<b>Advanced Option</b><br/>Default IP when DHCP server fail or doesn\'t exist.';var mgmt_fallback_mask=mgmt.option(form.Value,'fallback_nm',_('Fallback Netmask'));mgmt_fallback_mask.depends('proto','dhcp');mgmt_fallback_mask.value('255.255.255.0');mgmt_fallback_mask.value('255.255.0.0');mgmt_fallback_mask.value('255.0.0.0');mgmt_fallback_mask.default='255.255.255.0';mgmt_fallback_mask.optional=false;mgmt_fallback_mask.cond_optional=true;mgmt_fallback_mask.help_tip='<b>Advanced Option</b><br/>Default netmask when DHCP server fail or doesn\'t exist.';var s_ipv6=m.section(form.NamedSection,'wan6','interface',_('IPv6 Settings'));s_ipv6.sub_title_class=true;s_ipv6.addremove=false;s_ipv6.anonymous=true;var wan_type_ipv6=s_ipv6.option(form.ListValue,'proto',_('IP Address Mode'));wan_type_ipv6.value('dhcpv6','DHCP');wan_type_ipv6.value('static','Static IP');var dhcp_ipv6_clientid=s_ipv6.option(form.Value,'clientid',_('Client Id'));dhcp_ipv6_clientid.datatype='hostname_str(1, 63)';dhcp_ipv6_clientid.depends('proto','dhcpv6');var static_ipv6_ipaddr=s_ipv6.option(form.Value,'ip6addr',_('IP Address'));static_ipv6_ipaddr.optional=false;static_ipv6_ipaddr.force_required=true;static_ipv6_ipaddr.datatype='ip6addr';static_ipv6_ipaddr.default='';static_ipv6_ipaddr.depends('proto','static');var static_ipv6_gateway=s_ipv6.option(form.Value,'ip6gw',_('Default Gateway'));static_ipv6_gateway.optional=false;static_ipv6_gateway.force_required=true;static_ipv6_gateway.datatype='ip6addr';static_ipv6_gateway.depends('proto','static');var static_ipv6_dns=s_ipv6.option(form.Value,'dns',_('DNS'));static_ipv6_dns.optional=false;static_ipv6_dns.force_required=true;static_ipv6_dns.datatype='ip6addr';static_ipv6_dns.depends('proto','static');return m.render();}});